import { useEffect, useRef, useState, useCallback, useMemo } from 'react';
import { CheckCircle, XCircle } from 'lucide-react';
import AddressAutocomplete from './AddressAutocomplete';

const YandexMap = () => {
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const [address, setAddress] = useState('');
  const [apartment, setApartment] = useState('');
  const [isPrivateHouse, setIsPrivateHouse] = useState(false);
  const [addressResult, setAddressResult] = useState(null);
  const [isChecking, setIsChecking] = useState(false);
  const [isMapLoaded, setIsMapLoaded] = useState(false);

  // Зоны доставки из Yandex Map Constructor (координаты в формате [lat, lon])
  const deliveryZones = useMemo(() => [
    {
      name: 'Зелёная зона',
      color: '#56db40',
      fillOpacity: 0.6,
      strokeOpacity: 0.9,
      coordinates: [
        [51.543073863098925, 45.99761081818322], [51.536073642452806, 45.98596479888105], [51.53474316778343, 45.9864729287407],
        [51.53038366186661, 45.98822376153826], [51.526580879855764, 45.98973366433289], [51.52534611998436, 45.990222830563766],
        [51.524281990979816, 45.99064475623338], [51.522583683003084, 45.99131089049544], [51.52134379431212, 45.99181160933125],
        [51.51994155811584, 45.99236921902663], [51.51905969999756, 45.99272242948655], [51.51871833095689, 45.992853442375306],
        [51.51847317954544, 45.99294201449017], [51.51817113110146, 45.99306050997306], [51.517657393111406, 45.99326288194432],
        [51.516926101300875, 45.993720414437384], [51.51715117978527, 45.99346911994117], [51.516518614359896, 45.993720414437384],
        [51.516306502150485, 45.99380263211648], [51.5160048576346, 45.993923613967816], [51.51595297959893, 45.993939310193106],
        [51.51590110149828, 45.99396171194104], [51.515813034107744, 45.99399504763841], [51.515702060584026, 45.99403897401625],
        [51.51558235321245, 45.9940850596933], [51.51545430415134, 45.99413696055139], [51.515328987255124, 45.994187219643464],
        [51.515213194658045, 45.99423276492023], [51.51508270945408, 45.994285019232905], [51.51468655131956, 45.99444745255999],
        [51.5146166812694, 45.99447275663863], [51.514511248414856, 45.99451535964227], [51.5144043509649, 45.994558289965724],
        [51.51431157381541, 45.99459452045659], [51.5141997075407, 45.99463617754915], [51.514083107967004, 45.99468498158412],
        [51.5139917552996, 45.99472058139379], [51.51389859160172, 45.99475835513333], [51.51381142574415, 45.99479229997555],
        [51.51367914362717, 45.99484566378432], [51.513582459716005, 45.994882198027625], [51.51347805287237, 45.994923129819014],
        [51.51323934069432, 45.995019573112174], [51.513170932802986, 45.99504473584963], [51.513080872715385, 45.995080288209245],
        [51.512966806807306, 45.99512740176505], [51.51286249456459, 45.99516821690894], [51.51274987943581, 45.995208895169604],
        [51.51261784101146, 45.99526163774192], [51.512502450083645, 45.99530674204858], [51.51239078037331, 45.995350367569245],
        [51.512265071738966, 45.99539942068936], [51.51216231014803, 45.99543935665671], [51.512031850274816, 45.995488085215214],
        [51.51190804299433, 45.99553817857227], [51.51176205963964, 45.99559750106788], [51.51156456959012, 45.995674252091206],
        [51.51144427597054, 45.99571852312652], [51.511333291746595, 45.99576425716999], [51.51119892829629, 45.995814310328505],
        [51.51108258251161, 45.9958625091501], [51.51096771396543, 45.99590180488246], [51.51088161793631, 45.99593533256663],
        [51.510759697859584, 45.995984629302654], [51.51065229305148, 45.996022658840765], [51.51052724972325, 45.9960695366289],
        [51.5103849501254, 45.996121954431835], [51.51025311068422, 45.99617236057805], [51.51063128606162, 45.99919515271603],
        [51.511604025172794, 46.00235138475289], [51.51646511396894, 46.01803096559832], [51.522719840009096, 46.03788163657327],
        [51.5250448031117, 46.04928626167391], [51.525100404773994, 46.05083664229987], [51.52502730141477, 46.05232930757064],
        [51.52575730456368, 46.0554527559222], [51.526741605982096, 46.05971346089639], [51.52779280801149, 46.06311585898562],
        [51.53264698731633, 46.058732757056674], [51.53688044805534, 46.054503843602234], [51.540814223019524, 46.05076322424921],
        [51.54231254361966, 46.04376103873404], [51.551276322596046, 46.01133849616193], [51.54448487884418, 45.999941330632794],
        [51.544318053430224, 45.99963989661313], [51.54419805582193, 45.999437641254275], [51.54412509544878, 45.99930826889811],
        [51.544009801094774, 45.99910381572236], [51.543882537946835, 45.998883442415], [51.543747748374216, 45.998650322711946],
        [51.543604752871424, 45.99842703380294], [51.54349583348237, 45.9982590910635], [51.543407088027486, 45.998122462941126],
        [51.543310659464254, 45.99797465001079], [51.543262445105576, 45.99790205295182], [51.54318920883403, 45.99778715510137],
        [51.54311203296284, 45.99766849320613], [51.543073863098925, 45.99761081818322]
      ],
      minOrder: 2,
      deliveryTime: 'Быстрая доставка',
      description: 'Бесплатная доставка от 2 рублей'
    },
    {
      name: 'Синяя зона',
      color: '#1e98ff',
      fillOpacity: 0.6,
      strokeOpacity: 0.9,
      coordinates: [
        [51.53608524571294, 45.98592224205466], [51.54223911813969, 45.996235994877416], [51.54305493804828, 45.99756055465434],
        [51.543690117769366, 45.99853106284136], [51.544829082423625, 46.00049442425303], [51.54668962715914, 46.00356542993821],
        [51.54831554909815, 46.006292247236736], [51.549847554508894, 46.008829706342965], [51.551116000117524, 46.010853941787104],
        [51.55133429388786, 46.01133322483872], [51.55049086476042, 46.014154481386065], [51.549323070044984, 46.01842970888764],
        [51.54809183254689, 46.02287938680924], [51.54705566063346, 46.02666527141668], [51.54605277655569, 46.03028019190795],
        [51.54519056105375, 46.03338047689875], [51.54429066255542, 46.03669323642265], [51.543377366383154, 46.039995267110505],
        [51.542909057704506, 46.04154786042436], [51.54236596159627, 46.0434801891667], [51.541766834369625, 46.046243433577835],
        [51.54116551080996, 46.04905505726338], [51.54080837484423, 46.05074015316275], [51.53951682122124, 46.051966376835196],
        [51.53790104562201, 46.05350062112522], [51.53641234004854, 46.05494265769714], [51.53490685767137, 46.056459305870305],
        [51.53381953371489, 46.05752933561252], [51.53234073123478, 46.05900968470206], [51.53103586541424, 46.0601930513507],
        [51.528671274929565, 46.06232073488364], [51.52981962970163, 46.061283859307245], [51.53216037250378, 46.07569577192867],
        [51.5423303861189, 46.06728436445799], [51.549896197013766, 46.05776780035031], [51.56245291872888, 46.03159476152151],
        [51.57008556850653, 46.003190124792404], [51.56432693210715, 45.98716390429764], [51.54519029089668, 45.9702793769182],
        [51.50374017547648, 45.9723796537774], [51.50929995367663, 45.99652495875013], [51.51174678033926, 45.99559831103312],
        [51.51376007468081, 45.9948103134656], [51.515831040830186, 45.99398459711555], [51.51771324739267, 45.99323246972813],
        [51.52035172436687, 45.99219307124349], [51.522834868590124, 45.99118924492083], [51.5251974104569, 45.99026190091232],
        [51.5271616396999, 45.989472776203236], [51.528996962618436, 45.988745754298634], [51.53077449482241, 45.98802661671186],
        [51.53237254127945, 45.98740737172747], [51.53425904213523, 45.98662725596484], [51.53608524571294, 45.98592224205466]
      ],
      minOrder: 1700,
      deliveryTime: '60-90 мин',
      description: 'Бесплатная доставка от 1700 рублей'
    },
    {
      name: 'Оранжевая зона',
      color: '#ff931e',
      fillOpacity: 0.6,
      strokeOpacity: 0.9,
      coordinates: [
        [51.557073089974494, 46.04295588009382], [51.55696545696705, 46.04319006707465], [51.55686054066284, 46.043400661932786],
        [51.55674621923303, 46.043639410627875], [51.55664067542628, 46.04385732323641], [51.55653366838524, 46.04409013174199],
        [51.55641746514011, 46.044332668975905], [51.55628788563027, 46.04459523652738], [51.55617335375424, 46.04484198672594],
        [51.55601062320852, 46.045185613128915], [51.555855409806824, 46.04549107991268], [51.55576276827047, 46.04570111171661],
        [51.5556485455221, 46.045933782670346], [51.555524432728774, 46.04619034793946], [51.55538416272916, 46.04648014660521],
        [51.55525555923532, 46.04675064047558], [51.555142710380736, 46.04698587323286], [51.555034597815165, 46.04721524879481],
        [51.55488644078277, 46.04751729223307], [51.55463884945689, 46.04803509402664], [51.55445993900285, 46.04840727533939],
        [51.55424873599475, 46.04884226927832], [51.554124898035774, 46.0491006235572], [51.554002209292975, 46.04935646708434],
        [51.553782254212656, 46.04980880722912], [51.55366387782868, 46.050054382525126], [51.5535862231743, 46.05022517336169],
        [51.55347915473508, 46.05045099545162], [51.553361099721805, 46.05069921634174], [51.55319917392443, 46.05103502410011],
        [51.55309008016921, 46.05126310605826], [51.5529721959622, 46.05151211835244], [51.552702017160115, 46.052066922250724],
        [51.552584837163685, 46.05231753161245], [51.552436696842115, 46.05262502364537], [51.55230501575347, 46.052909427560806],
        [51.55163364526134, 46.054291381513416], [51.5514214453556, 46.05474219397087], [51.55106552260034, 46.05548298101617],
        [51.550533279180364, 46.05657809039871], [51.55012281620897, 46.05746381184374], [51.54985698240255, 46.05805513376045],
        [51.5451735991055, 46.06386252487301], [51.542335927454346, 46.067422054530475], [51.542034382837706, 46.067642882927856],
        [51.541720783745085, 46.0678989321778], [51.541227801608336, 46.0683177790304], [51.54099155295089, 46.068509715681714],
        [51.54073836829045, 46.068734270647354], [51.540506089458106, 46.068907790866156], [51.54029158067919, 46.06909207498128],
        [51.54007079865958, 46.06926141688735], [51.53986841418193, 46.06943229737517], [51.53963424919527, 46.069644496302885],
        [51.53867875986272, 46.070403957767965], [51.5384441705592, 46.070607415072224], [51.53799039518501, 46.07097275154226],
        [51.53779671763556, 46.07113463418346], [51.53760422843335, 46.07129661805589], [51.537394880796164, 46.07146338826346],
        [51.53722625200792, 46.07160658245956], [51.53709724481107, 46.07171480170061], [51.53684759288699, 46.07191741246777],
        [51.536575880539424, 46.072139341209876], [51.53632591210294, 46.07234787811627], [51.53606935586124, 46.072563214747866],
        [51.5358096617554, 46.072778946977664], [51.53552822024527, 46.073008629959894], [51.535276886897925, 46.07321864106589],
        [51.53509706351334, 46.07337526874603], [51.53458686304785, 46.073790825797474], [51.534097148829574, 46.074202346847486],
        [51.53388260967603, 46.07437392117051], [51.53382113336212, 46.07442916190157], [51.53358233680626, 46.07462553868149],
        [51.53220941013191, 46.07581066322484], [51.561595817055284, 46.093132369042685], [51.56532258033463, 46.06351826497486],
        [51.56555185191609, 46.05593714597929], [51.56697402020393, 46.05516871405143], [51.567649272697615, 46.05476374239924],
        [51.56816554284624, 46.05441513904677], [51.568156504516935, 46.053261956808456], [51.56794543386057, 46.05203920477404],
        [51.56876446028617, 46.051578535375405], [51.56953466550761, 46.05111853652961], [51.57073669129403, 46.05032057934783],
        [51.571613433529365, 46.04068186162331], [51.572788277874075, 46.03463616250357], [51.57438052961509, 46.02605443476053],
        [51.57485266629056, 46.023376249058934], [51.575108035334836, 46.02177362917283], [51.57623718681504, 46.01660635350568],
        [51.57707510020537, 46.01295854924521], [51.57754389686813, 46.0107953476747], [51.58162623110573, 45.98777519893763],
        [51.57701121706911, 45.97100431176674], [51.575255703111424, 45.966875426293385], [51.57219712971702, 45.971134347548286],
        [51.570972659241136, 45.97225586240211], [51.56944089375347, 45.973300037065485], [51.566100257686, 45.975508573538676],
        [51.5646746023209, 45.97653269447034], [51.563189420032884, 45.97579641280346], [51.5619854001551, 45.97512830056701],
        [51.56112926270671, 45.97299570559903], [51.5330960594994, 45.950723887145244], [51.522176422008414, 45.93739926420543],
        [51.497092537907605, 45.9430005380943], [51.49950659184484, 45.972941628069364], [51.502934460945305, 45.972210106500214],
        [51.50382165383406, 45.972354312640086], [51.504158113334874, 45.972332013905515], [51.50443514652165, 45.97231939290555],
        [51.505145716351834, 45.972277772277465], [51.50649597789702, 45.97221753351484], [51.5067565303775, 45.97220701214979],
        [51.507170235272234, 45.97219219879844], [51.50747319394669, 45.97216200597562], [51.50779121468629, 45.97214747827037],
        [51.50835862509504, 45.9721263389968], [51.513111872807734, 45.97188796047835], [51.51367503268129, 45.971858707446],
        [51.51516281218117, 45.971803265696], [51.51548245246981, 45.971787940099325], [51.51646813528681, 45.97174007956959],
        [51.51687750376849, 45.971710191316554], [51.51708616260069, 45.97170585821924], [51.5173768187868, 45.97169079628586],
        [51.51773827898104, 45.971673783566224], [51.51862183620485, 45.971633520049224], [51.51896906278441, 45.9716086757144],
        [51.51928783954213, 45.97159717933771], [51.519707851688665, 45.971562110890915], [51.5200734766222, 45.97155400961902],
        [51.5206606855657, 45.971529899819664], [51.52098369739739, 45.971508155906925], [51.521451446136965, 45.97148458051976],
        [51.522214038450976, 45.97144746253004], [51.522580061469604, 45.97142591993341], [51.52299167696603, 45.97140762793845],
        [51.52335894861124, 45.971393630441284], [51.52373040027629, 45.97137381937038], [51.52414786146298, 45.971347343256326],
        [51.52451029127745, 45.97133350695166], [51.52476228971843, 45.97131071629214], [51.5250370451485, 45.971301766820254],
        [51.525338943249295, 45.97129136200461], [51.52562567661051, 45.971273588719434], [51.52587371728068, 45.97125991712007],
        [51.5261096265397, 45.97124900002597], [51.526420824108875, 45.97123072821323], [51.52670775975782, 45.97121765440614],
        [51.527250933623264, 45.971190833542124], [51.52749713385062, 45.971185573766], [51.527738573367635, 45.971169390578126],
        [51.52786425459797, 45.971158241985314], [51.52812063512286, 45.97115215916156], [51.52833141111209, 45.971137897352264],
        [51.528558053677294, 45.97112560369349], [51.52876958571487, 45.971114826057494], [51.528967628160494, 45.971104458708965],
        [51.52918302709188, 45.97109510090808], [51.5294013527305, 45.97108089902524], [51.530028092035394, 45.97105736974424],
        [51.530253314552304, 45.97103988361318], [51.530492965137, 45.97102582154231], [51.53091203693366, 45.97100594903695],
        [51.53169496307363, 45.97096354600318], [51.53261505128254, 45.97091994202161], [51.532909475560004, 45.97090424047006],
        [51.5334573703316, 45.97087774657671], [51.533743736142654, 45.970866718270955], [51.533951484387764, 45.97085351562759],
        [51.53416744864124, 45.97084458931301], [51.5344668812342, 45.97082730110047], [51.53471278249724, 45.97081042811206],
        [51.53508246827849, 45.97078973067153], [51.53547720127921, 45.9707742347017], [51.53576115223622, 45.970767220848884],
        [51.53588953595738, 45.97074830192942], [51.537032009585616, 45.97069651860775], [51.53733727767386, 45.97067904328379],
        [51.53782444782501, 45.97065461015861], [51.53808496670768, 45.970641752776515], [51.538519858452524, 45.97061857207076],
        [51.538825116509685, 45.97060069315378], [51.53994242707645, 45.97054894263412], [51.54022593188404, 45.97053160772655],
        [51.54106221890942, 45.97049018625216], [51.54160997853807, 45.97046206343783], [51.54280833641449, 45.970402839051474],
        [51.54311105683197, 45.970389402740615], [51.5443921606122, 45.970328595347205], [51.54474587936197, 45.97032939275532],
        [51.545015211685346, 45.97030597162353], [51.54524554937975, 45.970300814465865], [51.54543742078674, 45.97048072973034],
        [51.54573845123875, 45.97073597618395], [51.54601523024875, 45.97097500284019], [51.54628364573862, 45.971210222308244],
        [51.55262501551094, 45.97648173117191], [51.556488275916145, 45.979892021770944], [51.55826978473171, 45.981793736312916],
        [51.558551711837346, 45.98204690511598], [51.55879622836383, 45.98225287337847], [51.559158193993184, 45.98257773513504],
        [51.55946164100738, 45.982848340905846], [51.559861218267834, 45.9832058043925], [51.560192873074215, 45.98349941088521],
        [51.56046099550385, 45.98373831615598], [51.5605976683677, 45.98385011016866], [51.56097383008046, 45.98418877622502],
        [51.56133912190695, 45.9845141438212], [51.56161914911291, 45.98474824354661], [51.56224272585747, 45.985292190639775],
        [51.56314296827298, 45.98609109306108], [51.56396044308038, 45.98682247362074], [51.56427146306817, 45.9870943690949],
        [51.56438006576062, 45.987186095271156], [51.564517922809145, 45.987560794498705], [51.564870127122035, 45.98848220088062],
        [51.56552812702847, 45.99026565849593], [51.56649142287282, 45.99226879521322], [51.569069740879826, 46.00024004488388],
        [51.569319272469656, 46.00093130307478], [51.56954965733122, 46.001573059148015], [51.56982185856589, 46.00232956665873],
        [51.57014292246817, 46.00323142838572], [51.570078651647556, 46.003469277883504], [51.56993582069278, 46.00400082926875],
        [51.569783114848526, 46.00456752207088], [51.56959835681728, 46.00525267816478], [51.56943442012345, 46.00587465403706],
        [51.569264337676856, 46.006493651081364], [51.56910335708466, 46.007101326051384], [51.568930863600315, 46.007746556105104],
        [51.568771088802336, 46.00833060252372], [51.568638750340625, 46.00884326124877], [51.56846767892684, 46.00945731683098],
        [51.56828600350015, 46.01012844987759], [51.5681423311006, 46.01068288624817], [51.56799603156324, 46.01122098666137],
        [51.56785474625764, 46.01173762940242], [51.5677395884564, 46.01217390269231], [51.567623811106465, 46.0125887301525],
        [51.567580529565774, 46.01276298745098], [51.567476231736, 46.013146370765256], [51.56741487667264, 46.01336596675505],
        [51.567293244195305, 46.013834663033805], [51.56720108715537, 46.014165876353694], [51.56701863494548, 46.01485244287465],
        [51.566877275828496, 46.01539945553989], [51.566741946662255, 46.015894007155474], [51.566584611397495, 46.016475414616544],
        [51.56643782453276, 46.01702802698763], [51.56632687306324, 46.01749086267089], [51.56598643889056, 46.01871518165773],
        [51.565664390303105, 46.0198992675095], [51.565347972688784, 46.02111171638359], [51.56512112376974, 46.02195411081313],
        [51.56485382233602, 46.022957618582566], [51.56459842511993, 46.02389711493324], [51.56439358578859, 46.02478369029944],
        [51.56410695903722, 46.02575965799843], [51.56386631686038, 46.02663659453701], [51.56357754983094, 46.02770918652468],
        [51.56332990756314, 46.02859909668092], [51.5631313595293, 46.0293972284942], [51.56284002360065, 46.03044900369039],
        [51.562615811333025, 46.03132678456288], [51.56243346758854, 46.031861941206046], [51.55942736734259, 46.03805244730801],
        [51.558771710639085, 46.039439671992255], [51.558189323213185, 46.04064180295253], [51.55807019834225, 46.04089888365775],
        [51.55772995926476, 46.041608382846405], [51.55743193448113, 46.0422206982985], [51.557235815709184, 46.04263200664612],
        [51.557073089974494, 46.04295588009382]
      ],
      minOrder: 2000,
      deliveryTime: '90-120 мин',
      description: 'Бесплатная доставка от 2000 рублей'
    },
    {
      name: 'Красная зона',
      color: '#ed4543',
      fillOpacity: 0.6,
      strokeOpacity: 0.9,
      coordinates: [
        [51.57429187884857, 46.07687213364788], [51.576984623398886, 46.091309862677434], [51.57952085924163, 46.088602029961],
        [51.581328993775884, 46.08604856697892], [51.58327073609475, 46.08654209343783], [51.58651235754898, 46.07817360131115],
        [51.585623441192645, 46.07461162773941], [51.584413684831034, 46.07212253777364], [51.58411291165138, 46.07016988961083],
        [51.58341109977773, 46.068646394890415], [51.57994866839958, 46.068281614463984], [51.57949244990943, 46.06559524680007],
        [51.57831428194453, 46.064754238938306], [51.57486817327627, 46.063839876335685], [51.572568393070256, 46.06227346627091],
        [51.5699475707163, 46.06203743187775], [51.565427632508644, 46.06302448479491], [51.570889601745414, 46.0695653277874],
        [51.57323258287012, 46.072746661930914], [51.57366788759893, 46.073649283827905], [51.57392936868059, 46.07468065175704],
        [51.57429187884857, 46.07687213364788]
      ],
      minOrder: 3000,
      deliveryTime: '120+ мин',
      description: 'Бесплатная доставка от 3000 рублей'
    }
  ], []);

  // Функция для проверки, находится ли точка в зоне доставки
  const checkPointInZones = useCallback((coordinates) => {
    const [lat, lon] = coordinates;
    
    // Проверяем зоны от самой маленькой (приоритетной) к самой большой
    for (let i = 0; i < deliveryZones.length; i++) {
      const zone = deliveryZones[i];
      if (isPointInPolygonRayCasting([lat, lon], zone.coordinates)) {
        return zone;
      }
    }
    
    return null; // Точка не входит ни в одну зону
  }, [deliveryZones]);

  // Классический алгоритм ray casting для проверки точки в полигоне
  const isPointInPolygonRayCasting = (point, polygon) => {
    const [x, y] = point;
    let inside = false;
    
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      const [xi, yi] = polygon[i];
      const [xj, yj] = polygon[j];
      
      if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
        inside = !inside;
      }
    }
    
    return inside;
  };

  const initMap = useCallback(() => {
    if (!mapRef.current) return;
    
    // Проверяем, что карта еще не создана
    if (mapInstanceRef.current) {
      return;
    }

    window.ymaps.ready(() => {
      // Проверяем еще раз, что карта не создана
      if (mapInstanceRef.current) {
        return;
      }
      
      // Очищаем div перед созданием карты
      if (mapRef.current) {
        mapRef.current.innerHTML = '';
      }
      
      // Создаем карту
      const map = new window.ymaps.Map(mapRef.current, {
        center: [51.5406, 46.0086], // Саратов
        zoom: 11,
        controls: ['zoomControl', 'fullscreenControl']
      });

      mapInstanceRef.current = map;

      // Добавляем зоны доставки (в обратном порядке, чтобы меньшие зоны были сверху)
      [...deliveryZones].reverse().forEach((zone) => {
        const polygon = new window.ymaps.Polygon(
          [zone.coordinates],
          {
            hintContent: zone.name,
            balloonContent: `
              <div>
                <h3>${zone.name}</h3>
                <p>${zone.description}</p>
                <p>Время доставки: ${zone.deliveryTime}</p>
              </div>
            `
          },
          {
            fillColor: zone.color,
            fillOpacity: zone.fillOpacity,
            strokeColor: zone.color,
            strokeWidth: 5,
            strokeOpacity: zone.strokeOpacity
          }
        );

        map.geoObjects.add(polygon);
      });

      // Добавляем маркер ресторана
      const restaurantPlacemark = new window.ymaps.Placemark(
        [51.5406, 46.0086], // ул. Чапаева, 89
        {
          hintContent: 'Tom Yang Bar',
          balloonContent: `
            <div>
              <h3>Tom Yang Bar</h3>
              <p>г. Саратов, ул. Чапаева, д. 89</p>
              <p>Саратов</p>
              <p>+7 (927) 112-65-00</p>
            </div>
          `,
          type: 'restaurant'
        },
        {
          preset: 'islands#redDotIcon',
          iconColor: '#dc2626'
        }
      );

      map.geoObjects.add(restaurantPlacemark);
      setIsMapLoaded(true);
    });
  }, [deliveryZones]);

  useEffect(() => {
    // Проверяем, загружена ли Яндекс.Карты API
    if (window.ymaps) {
      initMap();
    } else {
      // Ждем загрузки API
      const checkYmaps = setInterval(() => {
        if (window.ymaps) {
          clearInterval(checkYmaps);
          initMap();
        }
      }, 100);
      
      // Таймаут на случай, если API не загрузится
      setTimeout(() => {
        if (!window.ymaps) {
          clearInterval(checkYmaps);
        }
      }, 10000);
    }
    
    // Очистка при размонтировании компонента
    return () => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.destroy();
        mapInstanceRef.current = null;
      }
    };
  }, [initMap]);

  const checkAddress = async () => {
    if (!address.trim()) {
      setAddressResult({ success: false, message: 'Введите адрес' });
      return;
    }

    setIsChecking(true);
    
    // Сначала пробуем реальный геокодер
    if (window.ymaps && mapInstanceRef.current) {
      const searchQuery = address.includes('Саратов') ? address : `${address}, Саратов`;
      
      try {
        const res = await window.ymaps.geocode(searchQuery);
        
        const firstGeoObject = res.geoObjects.get(0);
        
        if (firstGeoObject) {
          const coordinates = firstGeoObject.geometry.getCoordinates();
          
          // Проверяем, в какой зоне находится адрес
          const foundZone = checkPointInZones(coordinates);
          
          if (foundZone) {
            setAddressResult({
              success: true,
              zone: foundZone,
              message: `Адрес входит в ${foundZone.name.toLowerCase()}`,
              minOrder: foundZone.minOrder,
              deliveryTime: foundZone.deliveryTime,
              coordinates: coordinates
            });
          } else {
            setAddressResult({ 
              success: false, 
              message: `Адрес не входит в зону доставки`,
              coordinates: coordinates
            });
          }

          // Перемещаем карту к найденному адресу с приближением
          if (mapInstanceRef.current) {
            mapInstanceRef.current.setCenter(coordinates, 16);
          }
          
          // Очищаем старые маркеры адресов (оставляем только ресторан)
          if (mapInstanceRef.current) {
            const geoObjects = mapInstanceRef.current.geoObjects;
            geoObjects.each((geoObject) => {
              if (geoObject.properties && geoObject.properties.get('type') === 'address') {
                geoObjects.remove(geoObject);
              }
            });
          }
          
          // Добавляем маркер адреса
          const addressPlacemark = new window.ymaps.Placemark(
            coordinates,
            {
              hintContent: address,
              balloonContent: foundZone ? `
                <div>
                  <h3>${address}</h3>
                  <p>${foundZone.name}</p>
                  <p>${foundZone.description}</p>
                  <p>Время доставки: ${foundZone.deliveryTime}</p>
                </div>
              ` : `
                <div>
                  <h3>${address}</h3>
                  <p style="color: red;">Адрес не входит в зону доставки</p>
                </div>
              `,
              type: 'address'
            },
            {
              preset: foundZone ? 'islands#blueDotIcon' : 'islands#redDotIcon',
              iconColor: foundZone ? '#3b82f6' : '#dc2626'
            }
          );

          mapInstanceRef.current.geoObjects.add(addressPlacemark);
          setIsChecking(false);
          return;
        }
      } catch {
        // Переключаемся на fallback режим
      }
    }
    
    // Fallback: тестовые координаты для демонстрации
    const testCoordinates = {
      'плякин': [51.5406, 46.0086],
      'плякина': [51.5406, 46.0086],
      'чапаева': [51.5406, 46.0086],
      'московская': [51.535, 46.005],
      'волжская': [51.545, 46.015],
      'проспект': [51.530, 46.010],
      'университетская': [51.525, 46.020]
    };
    
    // Ищем подходящие координаты по ключевым словам
    const addressLower = address.toLowerCase();
    let foundCoordinates = null;
    
    for (const [keyword, coords] of Object.entries(testCoordinates)) {
      if (addressLower.includes(keyword)) {
        foundCoordinates = coords;
        break;
      }
    }
    
    // Если не нашли по ключевым словам, используем случайные координаты в центре Саратова
    if (!foundCoordinates) {
      const baseLat = 51.5406;
      const baseLon = 46.0086;
      const offset = 0.01;
      
      foundCoordinates = [
        baseLat + (Math.random() - 0.5) * offset,
        baseLon + (Math.random() - 0.5) * offset
      ];
    }
    
    // Проверяем, в какой зоне находится адрес
    const foundZone = checkPointInZones(foundCoordinates);
    
    if (foundZone) {
      setAddressResult({
        success: true,
        zone: foundZone,
        message: `Адрес входит в ${foundZone.name.toLowerCase()} (демо-режим)`,
        minOrder: foundZone.minOrder,
        deliveryTime: foundZone.deliveryTime,
        coordinates: foundCoordinates
      });
    } else {
      setAddressResult({ 
        success: false, 
        message: `Адрес не входит в зону доставки (демо-режим)`,
        coordinates: foundCoordinates
      });
    }

    // Перемещаем карту к найденному адресу с приближением
    if (mapInstanceRef.current) {
      mapInstanceRef.current.setCenter(foundCoordinates, 16);
      
      // Очищаем старые маркеры адресов (оставляем только ресторан)
      const geoObjects = mapInstanceRef.current.geoObjects;
      geoObjects.each((geoObject) => {
        if (geoObject.properties && geoObject.properties.get('type') === 'address') {
          geoObjects.remove(geoObject);
        }
      });
      
      // Добавляем маркер адреса
      const addressPlacemark = new window.ymaps.Placemark(
        foundCoordinates,
        {
          hintContent: address,
          balloonContent: foundZone ? `
            <div>
              <h3>${address}</h3>
              <p>${foundZone.name} (демо-режим)</p>
              <p>${foundZone.description}</p>
              <p>Время доставки: ${foundZone.deliveryTime}</p>
            </div>
          ` : `
            <div>
              <h3>${address}</h3>
              <p style="color: red;">Адрес не входит в зону доставки (демо-режим)</p>
            </div>
          `,
          type: 'address'
        },
        {
          preset: foundZone ? 'islands#blueDotIcon' : 'islands#redDotIcon',
          iconColor: foundZone ? '#3b82f6' : '#dc2626'
        }
      );

      mapInstanceRef.current.geoObjects.add(addressPlacemark);
    }
    
    setIsChecking(false);
  };

  return (
    <div className="bg-white rounded-lg shadow-lg overflow-hidden">
      <div className="p-6">
        <h3 className="text-xl font-bold text-gray-900 mb-4">
          Проверьте зону доставки
        </h3>
        
        
        {/* Форма ввода адреса */}
        <div className="space-y-4 mb-6">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Улица
            </label>
            <div className="flex gap-2">
              <div className="flex-1">
                <AddressAutocomplete
                  value={address}
                  onChange={setAddress}
                  placeholder="Введите адрес"
                  onAddressSelect={(suggestion) => {
                    // Автоматически проверяем адрес при выборе из подсказок
                    setAddress(suggestion.title);
                    setTimeout(() => checkAddress(), 100);
                  }}
                />
              </div>
              <button
                onClick={checkAddress}
                disabled={isChecking}
                className="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isChecking ? 'Проверяем...' : 'Проверить'}
              </button>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Квартира или офис
              </label>
              <input
                type="text"
                value={apartment}
                onChange={(e) => setApartment(e.target.value)}
                placeholder="№"
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              />
            </div>
            <div className="flex items-center">
              <input
                type="checkbox"
                id="private-house"
                checked={isPrivateHouse}
                onChange={(e) => setIsPrivateHouse(e.target.checked)}
                className="mr-2"
              />
              <label htmlFor="private-house" className="text-sm text-gray-700">
                Частный дом
              </label>
            </div>
          </div>
          
          {/* Информация о зонах доставки */}
          <div className="mt-4 p-3 bg-gray-50 rounded-lg">
            <h4 className="text-sm font-semibold text-gray-900 mb-2">Зоны доставки</h4>
            <div className="space-y-2">
              {deliveryZones.map((zone, index) => (
                <div key={index} className="flex items-center justify-between text-xs">
                  <div className="flex items-center">
                    <div 
                      className="w-3 h-3 rounded-full mr-2"
                      style={{ backgroundColor: zone.color }}
                    ></div>
                    <span className="text-gray-700">{zone.name}</span>
                  </div>
                  <div className="text-right text-gray-600">
                    <div>от {zone.minOrder}₽</div>
                    <div className="text-xs text-gray-500">{zone.deliveryTime}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Результат проверки */}
        {addressResult && (
          <div className={`p-4 rounded-lg mb-6 ${
            addressResult.success 
              ? 'bg-green-50 border border-green-200' 
              : 'bg-red-50 border border-red-200'
          }`}>
            <div className="flex items-center">
              {addressResult.success ? (
                <CheckCircle className="w-5 h-5 text-green-600 mr-2" />
              ) : (
                <XCircle className="w-5 h-5 text-red-600 mr-2" />
              )}
              <div>
                <p className={`font-medium ${
                  addressResult.success ? 'text-green-800' : 'text-red-800'
                }`}>
                  {addressResult.message}
                </p>
                {addressResult.success && addressResult.zone && (
                  <div className="mt-2 text-sm text-green-700">
                    <p>{addressResult.zone.description}</p>
                    <p>Время доставки: {addressResult.deliveryTime}</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Карта */}
        <div className="relative">
          <div 
            ref={mapRef} 
            className="w-full h-80 rounded-lg"
            style={{ minHeight: '320px' }}
          />
          
          {!isMapLoaded && (
            <div className="absolute inset-0 bg-gray-100 rounded-lg flex items-center justify-center">
              <div className="text-center">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-2"></div>
                <p className="text-gray-600">Загрузка карты...</p>
              </div>
            </div>
          )}
          
          {/* Легенда зон */}
          <div className="absolute top-4 right-4 bg-white p-3 rounded-lg shadow-lg">
            <h4 className="font-semibold text-gray-900 mb-2 text-sm">Зоны доставки</h4>
            <div className="space-y-1">
              {deliveryZones.map((zone, index) => (
                <div key={index} className="flex items-center text-xs">
                  <div 
                    className="w-3 h-3 rounded-full mr-2"
                    style={{ backgroundColor: zone.color }}
                  ></div>
                  <span className="text-gray-700">{zone.name} (от {zone.minOrder}₽)</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default YandexMap;
