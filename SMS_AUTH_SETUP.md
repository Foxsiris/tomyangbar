# Настройка SMS-авторизации через SMS-Uslugi.ru

## Обзор

Система авторизации через SMS позволяет пользователям входить на сайт, используя только номер телефона и одноразовый код (OTP).

## Как это работает

1. Пользователь вводит номер телефона
2. Система отправляет 4-значный код через SMS
3. Пользователь вводит код
4. Если пользователь новый — просим ввести имя
5. Авторизация завершена, токен сохраняется на 30 дней

## Настройка сервиса SMS-Uslugi.ru

### Шаг 1: Регистрация

1. Перейдите на [https://lcab.sms-uslugi.ru/](https://lcab.sms-uslugi.ru/)
2. Создайте учетную запись
3. Подпишите договор об оказании услуг

### Шаг 2: Настройка имени отправителя

1. В личном кабинете перейдите в раздел **"Рассылка СМС"** → **"Мои имена"**
2. Добавьте имя отправителя (например, `TomYangBar`)
3. Дождитесь одобрения имени (обычно 1-2 рабочих дня)

### Шаг 3: Получение API-токена

1. В личном кабинете перейдите в раздел **API**
2. Создайте новый токен
3. Скопируйте токен

### Шаг 4: Настройка переменных окружения

Добавьте в файл `.env` в папке `backend`:

```env
# SMS-Uslugi.ru API
SMS_API_TOKEN=ваш_токен_из_личного_кабинета
SMS_SENDER_NAME=TomYangBar
```

## Режим разработки

В режиме разработки (без настроенного `SMS_API_TOKEN`) SMS не отправляются.
Вместо этого:

1. Код выводится в консоль сервера
2. Код показывается в интерфейсе с пометкой "Dev режим"

Это позволяет тестировать функционал без реальной отправки SMS.

## API Endpoints

### POST /api/auth/sms/send-code

Отправка кода верификации.

**Request:**
```json
{
  "phone": "+7 (999) 123-45-67"
}
```

**Response (успех):**
```json
{
  "success": true,
  "message": "Код отправлен"
}
```

**Response (dev режим):**
```json
{
  "success": true,
  "message": "Код отправлен",
  "devCode": "1234"
}
```

### POST /api/auth/sms/verify

Проверка кода и авторизация/регистрация.

**Request:**
```json
{
  "phone": "+7 (999) 123-45-67",
  "code": "1234",
  "name": "Иван" // опционально, для новых пользователей
}
```

**Response (существующий пользователь):**
```json
{
  "success": true,
  "isNewUser": false,
  "message": "Авторизация успешна",
  "user": { ... },
  "token": "jwt_token"
}
```

**Response (новый пользователь без имени):**
```json
{
  "success": true,
  "isNewUser": true,
  "message": "Регистрация успешна",
  "user": { ... },
  "token": "jwt_token",
  "bonusMessage": "Вам начислено 200 приветственных бонусов!"
}
```

### GET /api/auth/sms/check/:phone

Проверка существования пользователя по телефону.

**Response:**
```json
{
  "exists": true,
  "name": "Иван"
}
```

## Безопасность

- Код действителен 5 минут
- Максимум 5 попыток ввода кода
- Повторная отправка возможна через 60 секунд
- Телефоны нормализуются (убираются маски, +8 → +7)

## Стоимость

Актуальные тарифы смотрите на сайте [SMS-Uslugi.ru](https://sms-uslugi.ru/).
Примерная стоимость: ~2-3 рубля за SMS.

## Troubleshooting

### SMS не отправляются

1. Проверьте баланс в личном кабинете SMS-Uslugi
2. Убедитесь, что `SMS_API_TOKEN` корректен
3. Проверьте, что имя отправителя одобрено
4. Посмотрите логи сервера на наличие ошибок

### Код не приходит

1. Проверьте правильность номера телефона
2. Убедитесь, что номер не в чёрном списке оператора
3. Подождите 1-2 минуты (иногда бывают задержки)

### Ошибка "Подождите X сек."

Это защита от спама. Повторная отправка возможна только через 60 секунд после предыдущей.
