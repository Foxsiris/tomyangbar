#!/bin/bash

# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: ./generate-self-signed-cert.sh [IP_Ğ¸Ğ»Ğ¸_Ğ´Ğ¾Ğ¼ĞµĞ½]

set -e

DOMAIN_OR_IP=${1:-localhost}

echo "ğŸ”’ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ° Ğ´Ğ»Ñ: $DOMAIN_OR_IP"
echo ""

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ SSL
mkdir -p ssl

# Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ»ÑÑ‡Ğ°
echo "ğŸ“ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ»ÑÑ‡Ğ°..."
openssl genrsa -out ssl/privkey.pem 2048

# Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°
echo "ğŸ“ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°..."
openssl req -new -x509 -key ssl/privkey.pem -out ssl/fullchain.pem -days 365 \
    -subj "/C=RU/ST=State/L=City/O=Organization/CN=$DOMAIN_OR_IP" \
    -addext "subjectAltName=IP:$DOMAIN_OR_IP,DNS:$DOMAIN_OR_IP,DNS:localhost" 2>/dev/null || \
openssl req -new -x509 -key ssl/privkey.pem -out ssl/fullchain.pem -days 365 \
    -subj "/C=RU/ST=State/L=City/O=Organization/CN=$DOMAIN_OR_IP"

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
chmod 644 ssl/fullchain.pem
chmod 600 ssl/privkey.pem

echo ""
echo "âœ… Ğ¡Ğ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½!"
echo ""
echo "ğŸ“‹ Ğ¤Ğ°Ğ¹Ğ»Ñ‹:"
echo "  - ssl/fullchain.pem"
echo "  - ssl/privkey.pem"
echo ""
echo "âš ï¸  Ğ’ĞĞ–ĞĞ: Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸"
echo "   Ğ­Ñ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ñ… ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²."
echo "   Ğ’Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ½Ğ°Ğ¶Ğ°Ñ‚ÑŒ 'ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ' Ğ¸Ğ»Ğ¸ 'Advanced -> Proceed'"
echo ""
echo "ğŸš€ Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ:"
echo "   docker-compose -f docker-compose.https.yml up -d --build"
echo ""

